<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>{{ .Title }}</title>
    <style>
        .correct {
            background-color: #d4edda;
            padding: 0.5rem;
        }

        .incorrect {
            background-color: #f8d7da;
            padding: 0.5rem;
        }

        .result {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <h1>{{ .Title }}</h1>

    <form id="quiz-form">
        <input type="hidden" name="quiz_id" value="{{ .Params.id }}">
        <input type="hidden" name="user_id" value="user123"> <!-- Replace with actual user ID -->

        {{ range $index, $question := .Params.questions }}
        <div class="question" data-question-id="{{ $question.id }}" id="q-{{ $question.id }}">
            <p><strong>{{ $question.text }}</strong></p>

            {{ if eq $question.type "mcq" }}
            {{ range $optIndex, $option := $question.options }}
            <label>
                <input type="checkbox" name="selected_option_ids_{{ $question.id }}" value="{{ $option.id }}">
                {{ $option.text }}
            </label><br>
            {{ end }}
            {{ else if or (eq $question.type "short_answer") (eq $question.type "true_false") }}
            <input type="text" name="answer_text_{{ $question.id }}">
            {{ end }}
        </div>
        <hr>
        {{ end }}

        <button type="submit">Submit</button>
    </form>

    <div id="result" class="result" style="display: none;"></div>

    <script>
        document.getElementById("quiz-form").addEventListener("submit", async function (e) {
            e.preventDefault();

            const form = e.target;
            const payload = {
                id: form.querySelector("input[name='quiz_id']").value,
                user_id: form.querySelector("input[name='user_id']").value,
                answers: []
            };

            document.querySelectorAll(".question").forEach((questionEl) => {
                const questionID = questionEl.dataset.questionId;
                const selectedCheckboxes = questionEl.querySelectorAll("input[type='checkbox']:checked");
                const textInput = questionEl.querySelector("input[type='text']");

                const answer = {question_id: questionID};

                if (selectedCheckboxes.length > 0) {

                    answer.selected_option_id = Array.from(selectedCheckboxes).reduce((acc, cb) => {
                        acc[cb.value] = true;
                        return acc;
                    }, {})

                } else if (textInput && textInput.value.trim()) {
                    answer.answer_text = textInput.value.trim();
                }

                if (answer.selected_option_id || answer.answer_text) {
                    payload.answers.push(answer);
                }
            });

            console.log("Submitting payload:", payload);
            if (payload.answers.length === 0) {
                alert("Please answer at least one question.");
                return;
            }

            try {
                const res = await fetch(`http://localhost:9876/api/academy/quiz/${payload.id}/submit`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Failed to submit quiz");
                const data = await res.json();

                const resultEl = document.getElementById("result");
                resultEl.style.display = "block";
                resultEl.innerHTML = `
                  <h2>Results</h2>
                  <strong>Score:</strong> ${data.score}<br>
                  <strong>Grade:</strong> ${data.grade}
                `;

                document.querySelectorAll(".question").forEach((qEl) => {
                    const qid = qEl.dataset.questionId;
                    if (data.correct_submissions && data.correct_submissions[qid]) {
                        qEl.classList.add("correct");
                        qEl.classList.remove("incorrect");
                    } else {
                        qEl.classList.add("incorrect");
                        qEl.classList.remove("correct");
                    }
                });

            } catch (err) {
                alert("Error submitting quiz: " + err.message);
            }
        });
    </script>
</body>

</html>
